---
title: 网络层
date: 2017/05/02
tags: [计算机网络]
excerpt: 网络层的内容主要为多个网络通过路由器互连称为一个互联网络，其中主要的是IP协议和路由选择。
---

网络层主要讨论的是网络互联问题，也就是讨论多个网络通过路由器互连成为一个互联网络的各种问题。网络层的核心内容是网际协议IP，只有较深入的掌握了IP协议的主要内容，才能理解互连网是怎样工作的。

# 网际协议IP

网际协议IP是TCP/IP体系中最重要的两个协议之一，与IP协议配套使用的还有四个协议。`ARP`、`RARP`、`ICMP`、`IGMP`。

![网际协议IP及其配套协议](http://ojd8i48oc.bkt.clouddn.com/%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AEIP%E5%8F%8A%E5%85%B6%E9%85%8D%E5%A5%97%E5%8D%8F%E8%AE%AE.png)

从一般的概念来讲，将网络互相连接起来要使用一些中间设备。根据中间设备所在的层次，可以有以下四种不同的中间设备。

- 物理层使用的中间设备叫作`转发器`
- 链路层使用的中间设备叫作`网桥`或者`桥接器`
- 网络层使用的中间设备叫作`路由器`
- 网络层以上使用的中间设备叫作`网关`

# IP地址分类

IP地址是一个32位的标识符，用来进行寻址。32位比特标识以8位为一组，用十进制和`.`号标识则成为我们常见的形式，`xxx.xxx.xxx.xxx`。

IP地址的编址方法：

- 分类的IP地址，最基本的编址方法
- 子网划分的编址方法，这是对最基本的编址方法的改进
- 构成超网，新的无分类的编址方法

# 基本IP分类

所谓分类的IP地址就是将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成。其中第一个字段是`网络编号`，它标志主机或路由器连接到的网络。一个网络号在整个因特网中必须是唯一的。第二个字段是主机号，他标识该主机或路由器。一个主机号在它前面的网络号所指明的网络内必须唯一。由此可见，一个IP地址在整个因特网中是唯一的。

![基本分类IP地址](http://ojd8i48oc.bkt.clouddn.com/IP%E5%9C%B0%E5%9D%80%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8F%B7%E5%AD%97%E6%AE%B5.png)

#### A类地址

网络号字段占一个字节即前八位，第一位固定位0，所以A类网络前八位分别从00000000-01111111(0-127)。7位可用则有128个网络号，这里要减去2，因为有两个特殊的地方。

一是网络号字段全0表示本网络作为保留地址。

二是网络号字段全1为127(即01111111）保留作为本地软件环回测试本主机的进程之间的通信之用。若主机发送一个目的地址为环回地址(比如127.0.0.1）的IP数据报，则本主机中的协议软件直接处理数据报中的数据，而不会把数据报发送到任何网络。目的地址为环回地址的IP数据报永远不会出现在任何网络上，因为网络号为127的地址根本不是一个网络地址。

主机号字段占三个字节即后24位。24位则有2^24个主机号，也就是说每个A类网络中的最大主机数应该是2^24个，但这里要减去2。

因为主机号全0表示该IP地址所在的网络地址，如5.6.7.8所在的网络地址为5.0.0.0,；而主机号全1表示全部，即本网络上的所有主机，因此主机号为全1的地址表示该网络上的所有主机。

IP地址空间共有2^32个地址，A类地址空间共有2^31个，因此占整个IP地址空间的50%。

#### B类地址

结合A类地址中讲到的基础知识，B类地址网络号字段占两个字节即前16位，前两位固定为10，因此B类网络前八位分别为从10000000-10111111(128-191)。网络号字段全0也应减去，主机号字段全0全1也应减去。

#### C类地址

C类地址网络号字段占三个字节即前24位，前三位固定为110，因此C类网络前八位分别为从11000000-11011111(192-243)。网络号字段全0也应减去，主机号字段全0全1也应减去。

#### 全0或全1

网络号|主机号|代表的意思
--|--|--
全0|全0|本网络的本主机
全0|全1|本网络上的所有主机
全0|host-id|本网络上的某个主机
全1|全0|本网络地址
net-id|全1|广播地址，本网络上的所有主机
127|非全0或全1的任何数|本地软件环回测试之用


# IP和MAC

![IP地址和硬件地址的区别](http://ojd8i48oc.bkt.clouddn.com/IP%E5%9C%B0%E5%9D%80%E4%B8%8E%E7%A1%AC%E4%BB%B6%E5%9C%B0%E5%9D%80%E7%9A%84%E5%8C%BA%E5%88%AB.png)

IP地址放在IP分组的首部，而硬件地址则放在MAC帧的首部，在网络层和网络层以上使用的是IP地址，而数据链路层及以下使用的是硬件地址

# ARP和RARP

实际应用中，我们如果已经知道了一个机器的IP地址，需要找出其相应的物理地址；或反过来，知道了物理地址需要找出其对应的IP地址。ARP地址解析协议和RARP逆向地址解析协议就是用来实现这个需求的。

ARP的方法是在主机ARP高速缓存中存放一个IP地址到硬件地址的映射表，并且这个映射表还需经常更新。

# IP数据报(分组)的格式

![IP数据报的格式](http://ojd8i48oc.bkt.clouddn.com/IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F.png)

TCP/IP标准中，各种数据格式常以32位即4字节为单位来描述。从图可以看出，一个IP数据报由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。首部固定部分后面是可选字段。

# 子网划分

从主机号字段借用若干位来作为子网号，这样就形成了`<net-id>,<subnet-id>,<host-id>`的三级地址。

对于外部网络来说，目标主机的IP还是两级结构，当到达了目标主机时，就需要用子网掩码解析出该IP地址对应的子网所在。要验证是否进行了子网划分和子网号段有几位，可以用子网掩码和IP地址进行按位与操作，结果便是进行子网划分后的三级地址。

# CIDR无分类编址

CIDR把32位的IP地址划分为两个部分，前面的部分是网络前缀，用来指明网络，后面的部分则用来指明主机。

如：

18.14.35.7/20=**10000000 00001110 0010**0011 00000111

CIDR和基础的分类方式完全分离，更好的利用了地址空间。

# 路由选择

todo





