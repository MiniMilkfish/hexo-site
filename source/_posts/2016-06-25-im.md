---
title: 在线客服IM系统
date: 2016/06/25
tags: [方案总结]
excertp: 简单的一个项目总结。项目属于菜鸟网络的客服平台中心，一个常见的轮巡版及时聊天系统。
---

## 引言

#### 概述

简单的一个项目总结。

项目属于菜鸟网络的客服平台中心，客服平台中心的职责范围或者说重点当然是提供`客服`功能。消费者、商家(也多指各快递公司)和淘宝小二之间的沟通是一件值得关注而且费时费力的事情。在没有推出该项目之前，存在各快递公司的服务能力不能方便有效的服务到消费者的问题，虽然中心已经有了一个老版本的云客服平台，但是该平台和淘宝客服混杂，略显老旧，维护成本大，功能点模糊。为解决上述问题，PD便希望通过与菜鸟的客服平台系统配合，在淘宝(手淘)物流portal页提供IM服务流入口，希望将快递公司的服务能力很好的触达到消者。

所以平台中心的PD便酝酿了此项目。

客服平台中心自己的物流在线客服！这便是本项目的立项初衷。
    
#### 声明

- 本文意在总结方案经验，会尽量避免涉及具体实现细节和泄漏系统内部信息
- 该项目旨在提供中间消息转发的服务，以此有效的串接消费者和不同的快递公司
- 说白了就是一个hybrid模式的web端及时消息系统

## IM系统

WEB端的IM系统，目前来说常见的有`支付宝的人工客服`、`淘宝小蜜`（正确的归属关系来说的话，小蜜是和手淘平级的阿里内部系统应用。小蜜团队的目标是通过配置不同的机器人智能库和外露各类卡片式插件，将全集团涉及im或者客服系统的地方无缝接入进来。不得不说小蜜的野心和现有成果都是不容小觑的）、`滴滴的客服平台`和`内部乘客车主通信平台`等。

上面谈到的几个IM系统都有一个共通的地方，就是hybrid模式。提供h5页面并嵌入native的webview中，实现了快速开发和可移植性高的特点。但是，无论从页面载入、动态交互以及消息响应等方面都没法和原生app相比。

不过没办法，web端本身并没有网络通信的API可以使用。也正是因为web端的通信模式局限性，所以才有了利用http请求模拟sockets模式的思路。

## 后端接入

#### 后端概述 

客服平台提供中间服务转发的能力，即用户和CP方直接面向的都是服务平台，服务平台串接用户和CP方。
    
![各方关系](http://ojd8i48oc.bkt.clouddn.com/blog-im_flow_meitu_4.jpg)
  
#### 调用说明

菜鸟与CP之间采用HTTP方式进行通讯，通讯接口分为菜鸟主动发起请求调用CP服务和CP主动发起请求调用菜鸟接口两种模式。

- 主动模式接口
    - 创建会话
    - 消息下发
    - 评价结果下发
    - 会话结束下发
- 被动模式接口
    - 会话创建响应
    - 消息上传
    - 邀评请求上传
    - 会话结束上传

## 前后端协议

#### 主要协议

- 客户端出席
客户端向服务器发送出席报文，告知服务器该客户端已完成前置的初始化步骤，可以开始进行下个阶段的操作。出席操作可当做获取当前会话状态接口。
- 获取会话详情
客户端发起会话详情请求,服务器告知当前状态，分为有无会话，有会话则返回较为详细的当前会话状态值。   
- 请求加入会话
如果当前无会话存在，客户端向菜鸟服务器发起加入会话请求，菜鸟服务器调用CP服务器的接口，告知CP的服务器有用户需要接通CP的在线客服。    
- 加入会话成功   
CP服务器告知菜鸟服务器加入会话成功，菜鸟服务器告知客户端加入会话成功并返回相关会话状态。
- 排队 
加入会话成功后若人工客服繁忙，则进入排队等待状态，用户界面需实时更新当前状态。  
- 客服加入会话 
客服加入会话则进入用户和CP客服之间的实时会话状态
- 会话结束    
会话结束分为用户主动拉起结束请求和CP客服经确认后结束会话两种情况
- 会话超时
会话不可能一直存在，所以如果进入正常会话状态中的会话在用户持续特定一段时间无响应后则系统应主动结束当前会话，释放相关会话资源

#### 流程图

> **纯手工，自己画的。**

![流程图](http://ojd8i48oc.bkt.clouddn.com/blog-im_flows_meitu_5.jpg)

> 前后端接口定义统一为sendmessage和keepalive两个，不同的业务场景根据接口字段bizCode加以区分，客户端通过sendmessage主动发起请求以发送消息，通过keepalive发起请求以收取消息，具体实现可参照下方轮巡内容介绍。
      
## 消息轮巡

#### 概述
    
对于C2S模型，一些native应用可以通过套接口Sockets实现实时的收发消息，可以满足消息实时性的用户期待和满意度。但对于webApp，(早期)受限于web客户端(即浏览器环境)没有类似Sockets的实时网络通信的编程接口，而且cs通信大多数都基于http协议之上，所以web im的实时通信消息收发方案便应运而生，即轮巡机制。
   
轮巡分为长轮巡和短轮巡。
   
#### 轮巡

关于http的知识另外整理，后边更新。[Http常用知识总结](http://wangjizhi.com/2016/2016-08-07-http/)

http短轮询是服务器收到请求不管是否有数据都直接响应http请求，浏览器收到http响应后隔一段时间再次发送http请求。

http长轮巡是服务器收到请求后若没有数据则hold住一段时间，一段时间后再返回。浏览器端收到http响应后立马再次发起请求。

- 轮巡方案的区别点就是hold权的所有者，短轮巡由浏览器持有，长轮巡则由服务端持有。
- 短轮巡明显在实时性上差了一点，长轮巡对服务端资源消耗要求较高
- 该项目采用长轮巡机制，牺牲服务端资源以换取消息及时性
- http是请求/响应范式的，意为每一个响应必然对应一个客户端请求，所以不存在服务端推的通信模式
    
## http模拟心跳

#### 说明

轮巡只是一个解决方案，具体通过http的keepalive模拟心跳实现。
    
#### 收发消息

- 发消息
    
所有前端消息的发送均通过sendMessage接口，数据传参通过GET请求显示拼入url当中，该接口作为发送消息的唯一途径，接口只模拟返回http状态码和当前业务类型代码。众多的会话过程状态用`biz业务类型码`字段加以区分。
      
- 收消息
    
消息发送成功且服务端处理完毕后，服务端通过hold住的keepalive接口返回数据给客户端，客户端收到请求结果后立马再次发起新的keepalive请求。按照上述所讲的长轮巡方案保证keepalive不断，即客户端和服务端一直保持连接状态。以此构成整个会话的消息通道基础。
   
- 联系

sendMessage为消息发送接口，由前端控制何时发起、发起什么业务类型的请求。消息发送成功后获得成功的状态码，不成功根据业务类型进行重发等操作。该接口主动权在客户端，是客户端告知服务端相关信息的途径。
        
keepalive为消息接收接口，前端进入页面第一时间就应该立马建立起请求，并且由服务端控制，根据当前会话状态选择是否hold住。服务端若有消息通过此接口返回后，客户端应立马再次发起请求。该接口主动权在服务端，服务端决定保持hold状态或者消息返回状态，但当有消息返回后，请求的再次发起还是应该由客户端来完成，因为不存在服务端推的http模式。而且该接口不传参，只当作接受消息的唯一途径。根据服务端传回的bizcode区分当前会话状态。
        
sendMessage和keepalive两者统一构成了及时通信的实现机制。
    
#### 心跳保活

http连接是请求响应范式且无状态的，意味着模拟心跳是一种很不可靠的连接，用户在当前页面下会受限于网络原因等存在着不稳定的连接情境。如果keepalive请求在某次连接过程中出现异常断开，则整个的会话途径便被切断，而且用户并无感知。因此，心跳的保活成为最为重要的一个环节。

- 正常情况
   
keepalive接口由客户端管理发起时机，正常状态下服务端在某一特定时间段内有数据返回或者超出某一特定事件段无数据返回。有返回情况下立马发起第二次请求，若无返回则视为超时，也应发起新的keepalive请求。
   
- 异常情况
    - 系统被置于后台
    - 用户进入电梯等弱网络环境
    - 用户数据网络被短时切断后又成功连接
   
### 解决方案
   
(1) 通过设置本地缓存rs_id即请求唯一标识和定时器检测，确保心跳在死后能再次拉起。
   
(2) rs_id在每次请求发送时更新。
   
(3) 定时器间隔时间稍大于请求超时时间，定时器触发时会检测当前最新rs_id和定时器保存的最近上一次的rs_id是否相等，如果相等，则意味着在大于超时时间段内keepalive没有产生新的请求，此时说明该心跳已经死亡，此时应拉起新的心跳请求。

> 如下为保活方案示意图：

![保活方案示意图](http://ojd8i48oc.bkt.clouddn.com/blog-im_keepaliveOfManager.png)

## 成果图

**如下为最终的运行状态中的界面截图，也可以在手淘的物流详情页点击在线客服入口进入。**

{% img [] http://ojd8i48oc.bkt.clouddn.com/blog-im_result.jpg 300 手淘物流公司在线客服聊天界面 %}

## 总结

不够全面，仅作整理思路用，不同的im系统具体实现应根据业务需求确定方案。
   
现有的web im项目大部分还是http请求实现，偶然间看到钉钉网页版用websockets是用实现的。而且后续HTML新标准规范的推出和现有标准的逐步实现，浏览器环境下将可以拥有更多的API去实现之前没有的功能，比如一些本地文件操作、音视频、新图片类型的引入、HTTP2以及新的通信方式等等，期待！